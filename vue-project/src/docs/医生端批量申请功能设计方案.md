# 🔄 医生端批量申请功能设计方案

## 🎯 功能需求分析

### **核心需求**
- 在医生端数据管理页面添加【批量申请】按钮
- 点击后自动识别所有"未申请"状态的数据
- 批量发起授权申请，简化医生操作流程

### **用户场景**
```
医生登录 → 数据管理页面 → 查看多个未申请的数据 → 点击【批量申请】→ 
填写统一的申请理由和使用目的 → 批量提交申请 → 等待患者审批
```

## 🎨 UI设计方案

### **1. 批量申请按钮位置**
```vue
<!-- 页面标题和操作区 -->
<div class="page-header">
  <h2>数据管理</h2>
  <div class="header-actions">
    <el-button 
      type="primary" 
      @click="openBatchApplyDialog"
      :disabled="!hasUnrequestedData"
    >
      <el-icon><Document /></el-icon>
      批量申请
    </el-button>
    <el-button @click="refreshData" :loading="loading">
      <el-icon><Refresh /></el-icon>
      刷新
    </el-button>
  </div>
</div>
```

### **2. 批量申请对话框**
```vue
<el-dialog v-model="batchApplyDialogVisible" title="批量授权申请" width="700px">
  <div class="batch-apply-content">
    <!-- 申请数据列表 -->
    <el-alert
      title="将对以下未申请的数据发起授权申请"
      type="info"
      :closable="false"
      style="margin-bottom: 20px;"
    />
    
    <div class="data-preview">
      <el-tag v-for="data in unrequestedDataList" :key="data.id" style="margin: 4px;">
        {{ data.title }}
      </el-tag>
      <div class="data-count">共 {{ unrequestedDataList.length }} 条数据</div>
    </div>
    
    <!-- 统一申请表单 -->
    <el-form :model="batchApplyForm" :rules="batchApplyRules" label-width="100px">
      <el-form-item label="申请理由" prop="reason">
        <el-input
          v-model="batchApplyForm.reason"
          type="textarea"
          :rows="4"
          placeholder="请说明需要查看这些数据的理由"
        />
      </el-form-item>
      
      <el-form-item label="使用目的" prop="purpose">
        <el-select v-model="batchApplyForm.purpose" placeholder="请选择使用目的">
          <el-option label="诊断治疗" value="诊断治疗" />
          <el-option label="病情评估" value="病情评估" />
          <el-option label="医学研究" value="医学研究" />
          <el-option label="会诊咨询" value="会诊咨询" />
          <el-option label="其他" value="其他" />
        </el-select>
      </el-form-item>
    </el-form>
  </div>
  
  <template #footer>
    <div class="dialog-footer">
      <el-button @click="batchApplyDialogVisible = false">取消</el-button>
      <el-button 
        type="primary" 
        @click="submitBatchApply" 
        :loading="batchSubmitting"
      >
        提交申请 ({{ unrequestedDataList.length }}条)
      </el-button>
    </div>
  </template>
</el-dialog>
```

## 💻 技术实现方案

### **1. 数据状态管理**

#### **添加新的响应式数据**
```typescript
// 批量申请相关状态
const batchApplyDialogVisible = ref(false)
const batchSubmitting = ref(false)
const batchApplyForm = ref({
  reason: '',
  purpose: ''
})

// 表单验证规则
const batchApplyRules = ref({
  reason: [
    { required: true, message: '请输入申请理由', trigger: 'blur' },
    { min: 10, message: '申请理由至少10个字符', trigger: 'blur' }
  ],
  purpose: [
    { required: true, message: '请选择使用目的', trigger: 'change' }
  ]
})
```

#### **计算未申请数据**
```typescript
// 获取所有未申请的数据
const unrequestedDataList = computed(() => {
  return dataList.value.filter(data => 
    data.authStatus === 'not-requested' || data.authStatus === 'rejected'
  )
})

// 检查是否有未申请的数据
const hasUnrequestedData = computed(() => {
  return unrequestedDataList.value.length > 0
})
```

### **2. 核心业务逻辑**

#### **打开批量申请对话框**
```typescript
const openBatchApplyDialog = () => {
  if (unrequestedDataList.value.length === 0) {
    ElMessage.warning('当前没有需要申请的数据')
    return
  }
  
  // 重置表单
  batchApplyForm.value = {
    reason: '',
    purpose: ''
  }
  
  batchApplyDialogVisible.value = true
}
```

#### **批量提交申请**
```typescript
const submitBatchApply = async () => {
  if (!batchApplyFormRef.value) return
  
  try {
    await batchApplyFormRef.value.validate()
    
    batchSubmitting.value = true
    
    const { doctorApi } = await import('@/api')
    const reason = `${batchApplyForm.value.reason}\n使用目的：${batchApplyForm.value.purpose}`
    
    // 批量发送申请
    const promises = unrequestedDataList.value.map(data => 
      doctorApi.requestAuthorization(data.id, reason)
    )
    
    const results = await Promise.allSettled(promises)
    
    // 统计结果
    const successCount = results.filter(result => 
      result.status === 'fulfilled' && result.value.success
    ).length
    
    const failureCount = results.length - successCount
    
    // 显示结果
    if (successCount === results.length) {
      ElMessage.success(`批量申请成功！共提交 ${successCount} 条申请`)
    } else if (successCount > 0) {
      ElMessage.warning(`部分申请成功：${successCount} 条成功，${failureCount} 条失败`)
    } else {
      ElMessage.error(`批量申请失败：${failureCount} 条申请提交失败`)
    }
    
    batchApplyDialogVisible.value = false
    
    // 重新加载数据列表
    await loadDataList()
    
  } catch (error: any) {
    if (error !== 'cancel') {
      console.error('批量申请失败:', error)
      ElMessage.error('批量申请失败，请检查网络连接')
    }
  } finally {
    batchSubmitting.value = false
  }
}
```

### **3. 进度指示优化**

#### **带进度的批量申请**
```typescript
const submitBatchApplyWithProgress = async () => {
  try {
    batchSubmitting.value = true
    
    const totalCount = unrequestedDataList.value.length
    let completedCount = 0
    let successCount = 0
    
    // 创建进度提示
    const progressMessage = ElMessage({
      message: `正在提交申请... 0/${totalCount}`,
      type: 'info',
      duration: 0
    })
    
    // 逐个提交申请
    for (const data of unrequestedDataList.value) {
      try {
        const response = await doctorApi.requestAuthorization(data.id, reason)
        if (response.success) {
          successCount++
        }
      } catch (error) {
        console.error(`申请 ${data.title} 失败:`, error)
      }
      
      completedCount++
      
      // 更新进度
      progressMessage.close()
      progressMessage = ElMessage({
        message: `正在提交申请... ${completedCount}/${totalCount}`,
        type: 'info',
        duration: 0
      })
    }
    
    progressMessage.close()
    
    // 显示最终结果
    showBatchApplyResult(successCount, totalCount - successCount)
    
  } catch (error) {
    ElMessage.error('批量申请过程中发生错误')
  } finally {
    batchSubmitting.value = false
  }
}
```

## 🎨 UI/UX 优化

### **1. 视觉层次设计**

#### **按钮状态**
```scss
.header-actions {
  display: flex;
  gap: 12px;
  
  .batch-apply-btn {
    &:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .batch-count {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 12px;
      margin-left: 4px;
    }
  }
}
```

#### **数据预览样式**
```scss
.data-preview {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  max-height: 200px;
  overflow-y: auto;
  
  .el-tag {
    margin: 2px 4px 2px 0;
  }
  
  .data-count {
    margin-top: 12px;
    font-size: 14px;
    color: #606266;
    font-weight: 500;
  }
}
```

### **2. 交互反馈设计**

#### **加载状态**
```vue
<el-button 
  type="primary" 
  @click="submitBatchApply"
  :loading="batchSubmitting"
>
  <template v-if="batchSubmitting">
    <el-icon><Loading /></el-icon>
    提交中...
  </template>
  <template v-else>
    提交申请 ({{ unrequestedDataList.length }}条)
  </template>
</el-button>
```

#### **结果提示**
```typescript
const showBatchApplyResult = (successCount: number, failureCount: number) => {
  const totalCount = successCount + failureCount
  
  if (successCount === totalCount) {
    ElNotification({
      title: '批量申请成功',
      message: `成功提交 ${successCount} 条授权申请，请等待患者审批`,
      type: 'success',
      duration: 5000
    })
  } else if (successCount > 0) {
    ElNotification({
      title: '批量申请部分成功',
      message: `${successCount} 条申请成功，${failureCount} 条申请失败，请检查失败项目并重试`,
      type: 'warning',
      duration: 8000
    })
  } else {
    ElNotification({
      title: '批量申请失败',
      message: `所有 ${failureCount} 条申请都失败了，请检查网络连接或联系管理员`,
      type: 'error',
      duration: 10000
    })
  }
}
```

## 📱 响应式设计

### **移动端适配**
```scss
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    gap: 12px;
    
    .header-actions {
      width: 100%;
      justify-content: space-between;
      
      .el-button {
        flex: 1;
        max-width: 150px;
      }
    }
  }
  
  .batch-apply-dialog {
    width: 95% !important;
    margin: 5vh auto;
    
    .data-preview {
      max-height: 120px;
    }
  }
}
```

## 🧪 测试场景

### **功能测试用例**

#### **正常流程**
1. ✅ 页面加载后显示批量申请按钮
2. ✅ 有未申请数据时按钮可用，无数据时禁用
3. ✅ 点击按钮打开批量申请对话框
4. ✅ 对话框显示所有未申请的数据列表
5. ✅ 填写申请理由和使用目的
6. ✅ 提交批量申请并显示进度
7. ✅ 申请完成后刷新数据列表

#### **边缘情况**
1. ✅ 无未申请数据时的处理
2. ✅ 网络错误时的重试机制
3. ✅ 部分申请失败时的处理
4. ✅ 表单验证失败时的提示
5. ✅ 并发申请的防重复提交

#### **性能测试**
1. ✅ 大量数据时的批量申请性能
2. ✅ 并发请求的处理能力
3. ✅ 内存占用和UI响应性

## 📋 实施计划

### **Phase 1: 基础功能** (预估: 2-3小时)
- [ ] 添加批量申请按钮
- [ ] 实现获取未申请数据的计算属性
- [ ] 创建批量申请对话框

### **Phase 2: 核心逻辑** (预估: 2-3小时)
- [ ] 实现批量授权申请API调用
- [ ] 添加表单验证和错误处理
- [ ] 完善数据状态管理

### **Phase 3: 用户体验** (预估: 1-2小时)
- [ ] 添加进度指示和加载状态
- [ ] 优化交互反馈和通知
- [ ] 完善样式和响应式设计

### **Phase 4: 测试优化** (预估: 1小时)
- [ ] 功能测试和边缘情况处理
- [ ] 性能优化和代码重构
- [ ] 文档完善和代码注释

## 🎯 预期效果

### **用户价值**
- 🚀 **效率提升**: 一键申请多个数据，减少重复操作
- 🎯 **体验优化**: 统一的申请理由，简化填写流程
- 📊 **状态透明**: 清晰的进度提示和结果反馈

### **技术价值**
- 🧹 **代码复用**: 基于现有单个申请逻辑扩展
- 🛡️ **错误处理**: 完善的异常处理和重试机制
- 📱 **响应式**: 适配各种设备和屏幕尺寸

### **业务价值**  
- 📈 **使用效率**: 提高医生使用系统的效率
- 💡 **用户满意度**: 减少重复操作，提升用户体验
- 🔄 **流程优化**: 简化授权申请流程

这个批量申请功能将大大提升医生端的使用体验，让医生能够更高效地申请多个数据的授权！🎉
